<!-- templates/movies.html -->
{% extends "base.html" %}

{% block title %}Movies - Cinemacousas{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Calendar Strip -->
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="mb-3">
        <i class="fas fa-film me-2"></i>
        Current Movies
      </h2>
      
      <!-- Date Carousel -->
      <div class="date-carousel-container position-relative">
        <!-- Left Arrow -->
        <button id="prevBtn" class="carousel-nav-btn position-absolute start-0 top-50 translate-middle-y d-flex align-items-center justify-content-center" style="z-index: 10;">
          <i class="fas fa-chevron-left text-secondary"></i>
        </button>
        
        <!-- Date Carousel -->
        <div class="date-carousel overflow-hidden">
          <div class="date-carousel-track d-flex transition-transform" id="dateCarousel" style="transition: transform 0.3s ease;">
            <!-- Dates will be generated by JavaScript -->
          </div>
        </div>
        
        <!-- Right Arrow -->
        <button id="nextBtn" class="carousel-nav-btn position-absolute end-0 top-50 translate-middle-y d-flex align-items-center justify-content-center" style="z-index: 10;">
          <i class="fas fa-chevron-right text-secondary"></i>
        </button>
      </div>
    </div>
  </div>
  
  <div class="row" style="min-height: 30vh;">
    <div class="col-12">
      <!-- Movies Container - Always present for JavaScript to target -->
      <div id="moviesContainer">
        {% if movies %}
            {% for movie in movies %}
                <div class="col-12 mb-4">
                <div class="card movie-card h-100">
                    <div class="card-body p-3">
                        <!-- Top Section: Poster + Movie Info -->
                        <div class="d-flex flex-row mb-3">
                            <!-- Movie Poster -->
                            <div class="movie-poster-container d-flex justify-content-center align-items-start" style="width: 140px; min-width: 140px;">
                                {% if movie.poster %}
                                <img src="{{ url_for('serve_poster', poster_id=movie.poster.id) }}" 
                                        alt="{{ movie.name }} poster" 
                                        style="width: 140px; height: 100%; object-fit: cover; border-radius: 0.5rem;">
                                {% else %}
                                <div class="d-flex align-items-center justify-content-center bg-light"
                                        style="width: 140px; aspect-ratio: 2/3; border-radius: 0.5rem;">
                                    <i class="fas fa-film fa-2x text-muted"></i>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Movie Info -->
                            <div class="movie-info-container d-flex flex-column flex-grow-1 ps-3">
                                <!-- Movie Title -->
                                <h5 class="card-title fw-bold text-primary mb-2">
                                    {{ movie.name }}
                                </h5>
                            
                                <!-- Duration Badge -->
                                <div class="mb-3">
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-clock me-1"></i>
                                        {{ movie.duration }} min
                                    </span>
                                </div>
                                
                                <!-- Director -->
                                <p class="mb-2">
                                    <strong>Directed by:</strong> 
                                    <span class="text-muted">{{ movie.director }}</span>
                                </p>
                                
                                <!-- Cast -->
                                <p class="mb-0">
                                    <strong>Cast:</strong> 
                                    <span class="text-muted">{{ movie.cast }}</span>
                                </p>
                            </div>
                        </div>
                        
                        <!-- Middle Section: Synopsis -->
                        <div class="synopsis-section mb-3">
                            <h6 class="fw-bold mb-2">Synopsis</h6>
                            <p class="card-text text-muted small mb-0">
                                {{ movie.synopsis }}
                            </p>
                        </div>
                        
                        <!-- Bottom Section: Showings -->
                        <div class="showings-section pt-3 border-top">
                            <div class="showings-container" data-movie-id="{{ movie.id }}">
                                {% if movie.showings %}
                                    <div class="d-flex flex-wrap gap-2">
                                        {% for showing in movie.showings %}
                                            <button class="btn date-btn showing-time-btn" 
                                                    style="min-width: auto; padding: 0.75rem 1rem;" 
                                                    onclick="bookShowing({{ showing.id }})">
                                                <div class="d-flex flex-column align-items-center justify-content-center h-100">
                                                    <div class="fw-bold">{{ showing.starttime|seconds_to_time }}</div>
                                                </div>
                                            </button>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <p class="text-muted small mb-0">
                                        <i class="fas fa-info-circle me-1"></i>
                                        No showings available for today
                                    </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="centered-alert">
                <div class="text-black-50 text-center">
                    <p class="mb-0 fs-4">No movies are showing on the selected date.</p>
                </div>
            </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Handle booking a showing - define globally so onclick handlers can access it
function bookShowing(showingId) {
    // Redirect to the seat selection page
    window.location.href = `/showing/${showingId}/seats`;
}

document.addEventListener('DOMContentLoaded', function() {
    const dateCarousel = document.getElementById('dateCarousel');
    const showingsContainers = document.querySelectorAll('.showings-container');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    // Movies data with showings
    const moviesData = {{ movies|tojson }};
    console.log('Movies data:', moviesData);
    
    // Get default date from server (this includes cookie-based persistence)
    const defaultDate = '{{ default_date }}';
    console.log('Default date from server:', defaultDate);
    
    let currentOffset = 0;
    let selectedDate = null;
    const dateButtons = [];
    
    // Cookie utility functions
    function setCookie(name, value, days = 30) {
        const expires = new Date();
        expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
        document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
    }
    
    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }
    
    // Send date preference to server to update cookie
    function updateDatePreference(dateValue) {
        fetch('/set_movies_date_preference', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ date: dateValue })
        }).catch(error => {
            console.log('Failed to update server cookie:', error);
            // Fallback to client-side cookie
            setCookie('preferred_movies_date', dateValue);
        });
    }
    
    // Generate dates for the next 16 days
    function generateDates() {
        const dates = [];
        const today = new Date();
        
        for (let i = 0; i < 16; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);
            dates.push(date);
        }
        
        return dates;
    }
    
    // Format date for display
    function formatDisplayDate(date, index) {
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        if (index === 0) {
            return {
                dayName: 'Today',
                dayNumber: '',
                monthName: '',
                fullDate: date.toISOString().split('T')[0]
            };
        } else if (index === 1) {
            return {
                dayName: 'Tomorrow',
                dayNumber: '',
                monthName: '',
                fullDate: date.toISOString().split('T')[0]
            };
        } else {
            return {
                dayName: days[date.getDay()],
                dayNumber: date.getDate(),
                monthName: months[date.getMonth()],
                fullDate: date.toISOString().split('T')[0]
            };
        }
    }
    
    // Format time from timedelta object or seconds
    function formatTime(timeData) {
        let totalSeconds;
        
        // Handle different time formats
        if (typeof timeData === 'object' && timeData.seconds !== undefined) {
            totalSeconds = timeData.seconds;
        } else if (typeof timeData === 'number') {
            totalSeconds = timeData;
        } else if (typeof timeData === 'string') {
            // Handle HH:MM:SS format
            const parts = timeData.split(':');
            totalSeconds = parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
        } else {
            console.log('Unknown time format:', timeData);
            return '00:00';
        }
        
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        return String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
    }
    
    // Create date buttons
    function createDateButtons() {
        const dates = generateDates();
        dateCarousel.innerHTML = '';
        dateButtons.length = 0;
        
        dates.forEach((date, index) => {
            const dateInfo = formatDisplayDate(date, index);
            const isDefaultDate = dateInfo.fullDate === defaultDate;
            
            const dateButton = document.createElement('button');
            dateButton.className = `flex-shrink-0 date-btn ${isDefaultDate ? 'active' : ''}`;
            dateButton.dataset.date = dateInfo.fullDate;
            dateButton.style.minWidth = '140px';
            
            if (index <= 1) {
                // Today and Tomorrow
                dateButton.innerHTML = `
                    <div class="d-flex flex-column align-items-center justify-content-center h-100">
                        <div class="fw-bold">${dateInfo.dayName}</div>
                    </div>
                `;
            } else {
                // Other days
                dateButton.innerHTML = `
                    <div class="d-flex flex-column align-items-center justify-content-center h-100">
                        <div class="small text-uppercase">${dateInfo.dayName}</div>
                        <div class="fw-bold">${dateInfo.dayNumber}</div>
                        <div class="small">${dateInfo.monthName}</div>
                    </div>
                `;
            }
            
            dateButton.addEventListener('click', (e) => {
                console.log('Date button clicked!', {
                    date: dateInfo.fullDate,
                    buttonElement: dateButton,
                    event: e
                });
                selectDateHandler(dateInfo.fullDate, dateButton);
            });
            dateCarousel.appendChild(dateButton);
            dateButtons.push(dateButton);
        });
        
        // Set the selected date to the default date and update cookie preference
        selectedDate = defaultDate;
        console.log('Initial selected date set to:', selectedDate);
        
        // Scroll to show the active button if it's not today
        const activeButton = dateCarousel.querySelector('.date-btn.active');
        if (activeButton && defaultDate !== generateDates()[0].toISOString().split('T')[0]) {
            // If default date is not today, scroll to show the active button
            setTimeout(() => {
                scrollToShowButton(activeButton);
            }, 100);
        }
    }
    
    // Scroll carousel to show a specific button
    function scrollToShowButton(button) {
        const carouselContainer = dateCarousel.parentElement;
        const carouselContainerWidth = carouselContainer.offsetWidth;
        const buttonRect = button.getBoundingClientRect();
        const containerRect = carouselContainer.getBoundingClientRect();
        
        // Check if button is visible
        const isVisible = buttonRect.left >= containerRect.left && buttonRect.right <= containerRect.right;
        
        if (!isVisible) {
            // Calculate the offset needed to center the button
            const buttonOffsetLeft = button.offsetLeft;
            const buttonWidth = button.offsetWidth;
            const centerOffset = buttonOffsetLeft - (carouselContainerWidth / 2) + (buttonWidth / 2);
            
            // Ensure offset is within bounds
            let totalButtonsWidth = 0;
            dateButtons.forEach(btn => {
                totalButtonsWidth += btn.offsetWidth + 8;
            });
            totalButtonsWidth -= 8;
            
            const maxOffset = Math.max(0, totalButtonsWidth - carouselContainerWidth);
            currentOffset = Math.max(0, Math.min(centerOffset, maxOffset));
            
            updateCarousel();
        }
    }
    
    // Handle carousel navigation
    function updateCarousel() {
        const carouselContainer = dateCarousel.parentElement;
        const carouselContainerWidth = carouselContainer.offsetWidth;
        
        // Calculate total width of all buttons
        let totalButtonsWidth = 0;
        dateButtons.forEach(button => {
            totalButtonsWidth += button.offsetWidth + 8; // button width + margin
        });
        
        // Remove the last margin
        totalButtonsWidth -= 8;
        
        // Calculate maximum offset (how far we can scroll)
        const maxOffset = Math.max(0, totalButtonsWidth - carouselContainerWidth);
        
        // Ensure currentOffset doesn't exceed maxOffset
        currentOffset = Math.max(0, Math.min(currentOffset, maxOffset));
        
        // Apply transform
        dateCarousel.style.transform = `translateX(-${currentOffset}px)`;
        
        // Update button states
        prevBtn.disabled = currentOffset === 0;
        nextBtn.disabled = currentOffset >= maxOffset || maxOffset === 0;
        
        // Add visual feedback for disabled buttons
        if (prevBtn.disabled) {
            prevBtn.style.opacity = '0.5';
            prevBtn.style.cursor = 'not-allowed';
        } else {
            prevBtn.style.opacity = '1';
            prevBtn.style.cursor = 'pointer';
        }
        
        if (nextBtn.disabled) {
            nextBtn.style.opacity = '0.5';
            nextBtn.style.cursor = 'not-allowed';
        } else {
            nextBtn.style.opacity = '1';
            nextBtn.style.cursor = 'pointer';
        }
    }
    
    // Previous button handler
    prevBtn.addEventListener('click', () => {
        const carouselWidth = dateCarousel.parentElement.offsetWidth;
        const scrollAmount = Math.max(128, carouselWidth * 0.5); // Scroll by 50% of visible area or minimum 128px
        currentOffset = Math.max(0, currentOffset - scrollAmount);
        updateCarousel();
    });
    
    // Next button handler
    nextBtn.addEventListener('click', () => {
        const carouselContainer = dateCarousel.parentElement;
        const carouselWidth = carouselContainer.offsetWidth;
        const scrollAmount = Math.max(128, carouselWidth * 0.5); // Scroll by 50% of visible area or minimum 128px
        
        // Calculate total width of all buttons
        let totalButtonsWidth = 0;
        dateButtons.forEach(button => {
            totalButtonsWidth += button.offsetWidth + 8;
        });
        totalButtonsWidth -= 8;
        
        const maxOffset = Math.max(0, totalButtonsWidth - carouselWidth);
        currentOffset = Math.min(maxOffset, currentOffset + scrollAmount);
        updateCarousel();
    });
    
    // Select a date and update showings
    function selectDateHandler(selectedDateValue, buttonElement) {
        console.log('selectDateHandler called with:', {
            date: selectedDateValue,
            buttonElement: buttonElement,
            selectedDate: selectedDate
        });
        
        // Update active button first
        console.log('Updating active button states');
        document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
        buttonElement.classList.add('active');
        
        // Only skip fetch if it's the same date AND we're not on initial load
        if (selectedDateValue === selectedDate && selectedDate !== null) {
            console.log('Date already selected and data loaded, returning early');
            return;
        }
        
        console.log('Setting selected date to:', selectedDateValue);
        selectedDate = selectedDateValue;
        
        // Save date preference (both client and server)
        updateDatePreference(selectedDateValue);
        
        // Fetch movies for the selected date
        console.log('About to fetch movies for date:', selectedDateValue);
        fetchMoviesForDate(selectedDateValue);
    }
    
    function fetchMoviesForDate(selectedDateValue) {
        console.log('fetchMoviesForDate called with:', selectedDateValue);
        
        // Show loading state
        const moviesContainer = document.getElementById('moviesContainer');
        console.log('Movies container found:', !!moviesContainer);
        
        if (moviesContainer) {
            console.log('Setting loading state');
            moviesContainer.innerHTML = `
                <div class="col-12">
                    <div class="loading-container">
                        <div class="spinner"></div>
                    </div>
                </div>
            `;
        }
        
        const requestUrl = `/movies?date=${selectedDateValue}`;
        console.log('Making AJAX request to:', requestUrl);
        
        // Make AJAX request to get movies for the selected date
        fetch(requestUrl, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            console.log('Response received:', response.status, response.statusText);
            return response.json();
        })
        .then(data => {
            console.log('Data received:', data);
            updateMoviesList(data.movies);
        })
        .catch(error => {
            console.error('Error fetching movies:', error);
            if (moviesContainer) {
                moviesContainer.innerHTML = `
                    <div class="col-12">
                        <div class="centered-alert">
                            <div class="alert alert-danger text-center">
                                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                                <h4>Error Loading Movies</h4>
                                <p class="mb-0">Unable to load movies for the selected date. Please try again.</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        });
    }
    
    function updateMoviesList(movies) {
        const moviesContainer = document.getElementById('moviesContainer');
        if (!moviesContainer) return;
        
        if (movies.length === 0) {
            moviesContainer.innerHTML = `
                <div class="centered-alert">
                    <div class="text-black-50 text-center">
                        <p class="mb-0 fs-4">No movies are showing on the selected date.</p>
                    </div>
                </div>
            `;
            return;
        }
        
        let moviesHTML = '';
        movies.forEach(movie => {
            // Build poster HTML
            let posterHTML = '';
            if (movie.poster && movie.poster.id) {
                posterHTML = `<img src="/poster/${movie.poster.id}" 
                                   alt="${movie.name} poster" 
                                   class="img-fluid h-100 w-100"
                                   style="object-fit: cover; border-radius: 0.5rem;">`;
            } else {
                posterHTML = `<div class="h-100 w-100 d-flex align-items-center justify-content-center bg-light"
                                   style="border-radius: 0.5rem;">
                                <i class="fas fa-film fa-2x text-muted"></i>
                              </div>`;
            }
            
            moviesHTML += `
                <div class="col-12 mb-4">
                    <div class="card movie-card h-100">
                        <div class="card-body p-3">
                            <!-- Top Section: Poster + Movie Info -->
                            <div class="d-flex flex-row mb-3">
                                <!-- Movie Poster -->
                                <div class="movie-poster-container d-flex justify-content-center align-items-start" style="width: 140px; min-width: 140px;">
                                    ${posterHTML}
                                </div>
                                
                                <!-- Movie Info -->
                                <div class="movie-info-container d-flex flex-column flex-grow-1 ps-3">
                                    <!-- Movie Title -->
                                    <h5 class="card-title fw-bold text-primary mb-2">
                                        ${movie.name}
                                    </h5>
                                
                                    <!-- Duration Badge -->
                                    <div class="mb-3">
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-clock me-1"></i>
                                            ${movie.duration} min
                                        </span>
                                    </div>
                                    
                                    <!-- Director -->
                                    <p class="mb-2">
                                        <strong>Directed by:</strong> 
                                        <span class="text-muted">${movie.director}</span>
                                    </p>
                                    
                                    <!-- Cast -->
                                    <p class="mb-0">
                                        <strong>Cast:</strong> 
                                        <span class="text-muted">${movie.cast}</span>
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Middle Section: Synopsis -->
                            <div class="synopsis-section mb-3">
                                <h6 class="fw-bold mb-2">Synopsis</h6>
                                <p class="card-text text-muted small mb-0">
                                    ${movie.synopsis}
                                </p>
                            </div>
                            
                            <!-- Bottom Section: Showings -->
                            <div class="showings-section pt-3 border-top">
                                <div class="showings-container" data-movie-id="${movie.id}">
                                    ${generateShowingsHTML(movie.showings)}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        // Wrap the movies in a row div to match server-rendered HTML structure
        moviesContainer.innerHTML = moviesHTML
    }
    
    function generateShowingsHTML(showings) {
        if (!showings || showings.length === 0) {
            return `
                <p class="text-muted small mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    No showings available for this date
                </p>
            `;
        }
        
        const showingsButtons = showings.map(showing => `
            <button class="btn date-btn showing-time-btn" 
                    style="min-width: auto; padding: 0.75rem 1rem;" 
                    onclick="bookShowing(${showing.id})">
                <div class="d-flex flex-column align-items-center justify-content-center h-100">
                    <div class="fw-bold">${formatTime(showing.starttime)}</div>
                </div>
            </button>
        `).join('');
        
        return `<div class="d-flex flex-wrap gap-2">${showingsButtons}</div>`;
    }
    
    function updateShowings(selectedDateValue) {
        // This function is no longer needed since we're fetching from server
        // But keeping it for backward compatibility
        console.log('updateShowings called - this should not happen anymore');
    }
    
    // Initialize the carousel
    createDateButtons();
    updateCarousel();
    
    // Handle window resize
    window.addEventListener('resize', () => {
        updateCarousel();
    });
});
</script>
{% endblock %}
